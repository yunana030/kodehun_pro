<!--&lt;!&ndash;ë””ìì¸ìˆ˜ì • í•„ìš”, í˜ì´ì§•ì²˜ë¦¬í•  ë•Œ í•˜ë‹¨ ë²„íŠ¼ ì´ë¦„ê³¼ ê¸°ëŠ¥ ìˆ˜ì •í•  ê²ƒ!&ndash;&gt;-->

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}">

<head>
    <title>Place List</title>
</head>

<body>
<section layout:fragment="content" class="meditation-view">

    <div class="container my-5" style="padding-top: 75px" th:if="${#authorization.expression('isAuthenticated()')}">

        <!-- ë³¸ë¬¸ ì‹œì‘ -->
        <div class="row g-4">
            <div class="col-md-7">

            <!-- ì™¼ìª½: ì´ë¯¸ì§€ + ë²„íŠ¼ + ìƒì„¸ë‚´ìš© -->
                <div class="free-detail-card">
                    <div class="place-title-row d-flex justify-content-between align-items-center">
                        <h2 class="place-name" th:text="${place.placename}">Place Name</h2>
                        <p class="place-region place-category" th:text="'ì§€ì—­: ' + ${place.sido}">ì§€ì—­: ì„œìš¸</p>
                    </div>
                    <!-- ë‘ ë²ˆì§¸ ì¤„: ì‘ì„±ì + ë“±ë¡ì¼ (ì¢Œì¸¡) / ì¹´í…Œê³ ë¦¬ (ìš°ì¸¡) -->
                    <div class="place-title-row d-flex justify-content-between align-items-center mt-1">
                        <p class="place-author place-category" th:text="'ì‘ì„±ì: ' + ${place.username}">ì‘ì„±ì: username</p>
                        <h6 class="place-category" th:text="'ì¹´í…Œê³ ë¦¬: ' + ${place.category}">ì¹´í…Œê³ ë¦¬: TOUR</h6>
                    </div>
                    <h3 th:class="free-title"></h3>
                    <!-- ì´ë¯¸ì§€ -->
                    <div class="left-image w-100 mb-4">
                        <div th:if="${place.images != null && !place.images.isEmpty()}" class="yuna-view-image-container">
                            <img th:each="imgDTO, iterStat : ${place.images}"
                                 th:src="@{'/uploads/' + ${imgDTO.uuid} + '_' + ${imgDTO.fileName}}"
                                 th:classappend="${iterStat.index == 0} ? 'active' : 'd-none'"
                                 class="yuna-view-image"
                                 alt="Place Image">
                            <button class="yuna-view-prev">&lt;</button>
                            <button class="yuna-view-next">&gt;</button>
                        </div>
                    </div>

                    <!-- ì¢‹ì•„ìš” & ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ -->
                    <div class="mb-3 like-fav-container">
                        <button id="likeBtn" class="btn btn-sm d-flex align-items-center gap-1">
                            <i class="far fa-heart text-muted"></i>
                            <span id="likeCount" th:text="${place.like_count}">0</span>
                        </button>
                        <button id="favoriteBtn" class="btn btn-sm d-flex align-items-center gap-1">
                            <i class="far fa-bookmark text-muted"></i>
                            <span id="favoriteCount"></span>
                        </button>
                    </div>

                    <!-- ìƒì„¸ ë‚´ìš© -->
                    <div class="content-area card shadow-sm mb-4 p-3">
                        <div class="section-heading">
                            <!-- ìƒì„¸ë‚´ìš©ìš© ì¥ì†Œëª… (íƒ€ì´í‹€ë³´ë‹¤ ì‘ê²Œ) -->
    <!--                        <h4 class="place-name-detail" th:text="${place.placename}">Place Name</h4>-->
                            <p class="place-name-detail" th:text="${place.placename}">Place Name</p>

                            <!-- ë‚´ìš© -->
                            <p class="place-content" th:text="${place.content}">Place Content</p>

                            <!-- ì£¼ì†Œ + ì¡°íšŒìˆ˜ í•œ ì¤„ -->
                            <div class="place-info d-flex justify-content-between">
                                <span class="place-addr" th:text="${place.addr}">Address</span>
                                <span class="place-readcount">ì¡°íšŒìˆ˜: <span th:text="${place.readCount}">0</span></span>
                            </div>
                        </div>
                    </div>
                    <!-- ëª©ë¡/ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ì¢Œì¸¡ í•˜ë‹¨) -->
                    <div class="text-start mt-8 action-buttons" th:with="link=${requestDTO.getLink()}">
                        <span th:if="${#authentication?.principal?.username == place.username || #authentication?.principal?.member?.role == 'ADMIN'}">
                            <a th:href="@{/place/modify/{id}(id=${place.id}, ${link})}" class="yuna-search-btn">ìˆ˜ì •</a>
                            <a th:href="@{/place/delete/{id}(id=${place.id})}" class="yuna-search-btn">ì‚­ì œ</a>
                        </span>
                        <a th:href="@{/place/list(
                                  page=${requestDTO.page},
                                  size=${requestDTO.size},
                                  category=${requestDTO.category},
                                  keyword=${requestDTO.keyword},
                                  type=${requestDTO.type}
                                )}" class="yuna-search-btn">ëª©ë¡</a>
                    </div>


                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ëŒ“ê¸€ ì˜ì—­ -->
            <div class="col-md-5">
                <div class="reply-card">
                    <h5 class="border-bottom pb-2 mb-4 fw-semibold">ğŸ’¬ ëŒ“ê¸€</h5>

                    <input type="hidden" id="loginUsername" th:value="${#authentication?.principal?.username}" />
                    <input type="hidden" id="loginRole" th:value="${#authentication?.principal?.member?.role}" />

                    <!-- ëŒ“ê¸€ ëª©ë¡ -->
                    <ul id="replyList" class="list-group mb-4"></ul>

                    <!-- í˜ì´ì§• -->
                    <div class="d-flex justify-content-center mb-4">
                        <nav>
                            <ul class="pagination" id="replyPagination"></ul>
                        </nav>
                    </div>

                    <!-- ëŒ“ê¸€ ì‘ì„± -->
                    <div class="card shadow-sm mb-4 mt-8">
                        <div class="reply-card">
                            <div th:if="${#authentication?.principal != null}">
                                <form id="replyForm">
                                    <div class="mb-3">
                                        <label for="replyWriter" class="form-label fw-semibold">ì‘ì„±ì</label>
                                        <input type="text" id="replyWriter" class="form-control"
                                               th:value="${#authentication.principal.username}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="replyContent" class="form-label fw-semibold">ëŒ“ê¸€ ì‘ì„±</label>
                                        <textarea id="replyContent" class="form-control" rows="3"
                                                  placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="button" id="replyRegisterBtn" class="admin-btn">ë“±ë¡</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì -->
    <div th:unless="${#authorization.expression('isAuthenticated()')}" class="text-center" style="padding-top: 10rem;">
        <h3 class="text-muted">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</h3>
    </div>

    <style>
        .meditation-view {
            min-height: calc(77vh);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            padding: 3rem 1rem 2rem;
            margin-top: 40px;
        }

        /* ëŒ“ê¸€ ì‘ì„± ì˜ì—­ ì „ì²´ ë†’ì´ ì¤„ì´ê¸° */
        .yuna_design_reply {
            height: 50%;
            min-height: 150px;
            max-height: 300px;
            overflow: hidden;  /* ë‚´ìš© ë„˜ì¹˜ë©´ ìˆ¨ê¸°ê¸° */
            padding: 0;
            margin: 0;
        }
        /* ì¹´ë“œ ë‚´ë¶€ body íŒ¨ë”© ì¡°ì ˆ */
        .yuna_design_reply .card-body {
            padding: 0;        /* ì¹´ë“œ ì•ˆìª½ ì—¬ë°± ì¤„ì´ê¸° */
        }
        /* form ìš”ì†Œ ê°„ê²© ì¤„ì´ê¸° */
        .yuna_design_reply #replyForm .mb-3 {
            margin-bottom: 0.5rem;  /* ë ˆì´ë¸”ê³¼ ì…ë ¥ì¹¸ ê°„ ê°„ê²© ì¤„ì„ */
        }

        .button-box {
            display: flex;
            gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }
        .place-category {
            font-size: 14px;
            color: #777;
            margin: 0;
        }

        .content-area {
            background-color: #fff;
            border-radius: 12px;             /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* ì‚´ì§ ê·¸ë¦¼ì */
            margin-bottom: 20px;
            width: 750px;/* ì•„ë˜ ì—¬ë°± */
            max-width: 100%
        }

        .section-heading h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .section-heading h6 {
            font-size: 14px;
            color: #777;
            margin-bottom: 8px;
        }

        .section-heading p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        /* ì¢‹ì•„ìš” & ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .like-fav-container {
            display: flex;
            align-items: center;    /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            gap: 20px;              /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .like-fav-container button {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            background: none;
            border: none;
            cursor: pointer;
        }

        .like-fav-container i {
            font-size: 2rem;
            color: #555;
            transition: color 0.2s ease;
        }

        /* hover ì‹œ ìƒ‰ìƒ ê°•ì¡° */
        .like-fav-container button:hover i {
            color: #ff4d6d;
        }
        .like-fav-container span {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            margin-left: 4px;       /* ì•„ì´ì½˜ê³¼ ì‚´ì§ ë„ìš°ê¸° */
        }
    /*1113, yunaì¶”ê°€ css*/
        .place-name {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            font-weight: 700;
            font-size: 28px;
            line-height: 1.3;
            margin: 0;
        }
        .place-category, .place-author, .place-region {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            font-weight: 500;
            font-size: 14px;
            line-height: 1.4;
            margin: 0;
        }
        .place-title-row + .place-title-row {
            margin-top: 6px;
        }
        .place-content {

            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
            font-size: 16px;
            color: #333;
        }

        .place-addr, .place-readcount {
            font-size: 14px;
            color: #777;
            margin-top: 0.5rem;
        }

        .section-heading p {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            color: #333;
            margin-bottom: 10px;
        }
        .place-name-detail {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
        }
        .place-addr, .place-readcount {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: #777;
            margin: 0;
        }

        .content-area .place-name-detail {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            display: inline-block;
            padding-bottom: 0.25em;
            border-bottom: 0.3em solid rgba(45, 90, 135, 0.25);
        }

        /* ì „ì²´ ì„¹ì…˜ */
        .content-container {
            padding-top: 6rem;
            padding-bottom: 6rem;
        }

        /* ë©”ì¸ ì¹´ë“œ */
        .free-detail-card {
            background: #fff;
            border-radius: 1.2rem;
            padding: 2.5rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: 0.3s;
            display: flex;
            flex-direction: column; /* ìœ„ì—ì„œ ì•„ë˜ë¡œ ìŒ“ì´ë„ë¡ */
            flex: 1;
        }

        .free-detail-card label {
            font-weight: 600;
            color: #495057;
        }

        .text-start.mt-8 {
            margin-top: auto;
        }

        .row.g-4 {
            display: flex;
            align-items: stretch;
        }

        .col-md-7, .col-md-5 {
            display: flex;
            flex-direction: column;
        }

        .free-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #2e3a59;
            border-bottom: 2px solid #4e73df;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* ëŒ“ê¸€ ì¹´ë“œ */
        .reply-card {
            background: #fdfdfd;
            border-radius: 1.2rem;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #replyList {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        #replyForm {
            margin-top: auto !important;       /* ë§¨ ì•„ë˜ ê³ ì • */
        }

        /* ëŒ“ê¸€ í•­ëª© */
        .list-group-item {
            border: none;
            margin-bottom: 0.6rem;
            border-radius: 0.6rem;
            background: #f8f9fa;
            transition: 0.2s;
        }

        .list-group-item:hover {
            background: #eef2ff;
        }

        .list-group-item strong {
            color: #2e3a59;
        }

        .list-group-item small {
            color: #868e96;
        }
        /* ëŒ“ê¸€ ë²„íŠ¼ */
        .edit-btn, .delete-btn {
            border-radius: 0.4rem;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .edit-btn {
            border: 1px solid #4e73df;
            color: #4e73df;
        }

        .edit-btn:hover {
            background: #4e73df;
            color: #fff;
        }

        .delete-btn {
            border: 1px solid #e74a3b;
            color: #e74a3b;
        }

        .delete-btn:hover {
            background: #e74a3b;
            color: #fff;
        }

        /* ëŒ“ê¸€ ì…ë ¥ */
        #replyForm textarea {
            resize: none;
        }

    </style>


    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.placeId = [[${place.id}]];
        /*]]>*/
    </script>
    <script src="/js/place.js"></script>
    <script src="/js/reply.js"></script>
</section>
<script layout:fragment="script" th:inline="javascript">
    document.addEventListener("DOMContentLoaded", async () => {
        const replyList = document.querySelector("#replyList")
        const replyContent = document.querySelector("#replyContent")
        const replyRegisterBtn = document.querySelector("#replyRegisterBtn")
        const replyWriter = document.querySelector("#replyWriter")
        // const placeId = [[${place.id}]]  // ê²Œì‹œê¸€ ID
        const placeId = window.placeId;
        const loggedInUser = document.querySelector("#loginUsername").value
        const userRole = document.querySelector("#loginRole").value
        const isAdmin = userRole === 'ADMIN'

        const likeBtn = document.querySelector("#likeBtn")
        const likeCountEl = document.querySelector("#likeCount")
        const likeIcon = likeBtn.querySelector('i')

        const favoriteBtn = document.querySelector("#favoriteBtn")
        const favoriteCountEl = document.querySelector("#favoriteCount")
        const favoriteIcon = favoriteBtn.querySelector('i')

        // ì¦ê²¨ì°¾ê¸° ì¶”ê°€

        // ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë¡œë“œ
        async function loadFavoriteStatus() {
            try {
                const response = await axios.get(`/place/${placeId}/favorite/status`)
                const { favorited, loginRequired } = response.data

                if (loginRequired) {
                    favoriteBtn.classList.remove("btn-warning")
                    favoriteBtn.classList.add("btn-outline-warning")
                    favoriteIcon.classList.replace("fas", "far")
                    favoriteCountEl.textContent = ""
                    return
                }

                // ì¦ê²¨ì°¾ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
                if (favorited) {
                    favoriteIcon.classList.replace("far", "fas")
                    favoriteIcon.classList.replace("text-muted", "text-warning")  // ë…¸ë‘
                } else {
                    favoriteIcon.classList.replace("fas", "far")
                    favoriteIcon.classList.replace("text-warning", "text-muted")
                }
            } catch (error) {
                console.error("ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨", error)
            }
        }

        // ì¦ê²¨ì°¾ê¸° í´ë¦­
        favoriteBtn.addEventListener("click", async () => {
            try {
                await axios.post(`/place/${placeId}/favorite`)
                await loadFavoriteStatus()
            } catch (error) {
                alert("ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                console.error(error)
            }
        })


        // ì¢‹ì•„ìš”
        // ì¢‹ì•„ìš” ìƒíƒœ ë¡œë“œ
        async function loadLikeStatus() {
            try {
                const response = await axios.get(`/place/${placeId}/like/status`)
                const { liked, count } = response.data

                likeCountEl.textContent = count

                // ì¢‹ì•„ìš” ìƒíƒœ ì—…ë°ì´íŠ¸
                if (liked) {
                    likeIcon.classList.replace("far", "fas")
                    likeIcon.classList.replace("text-muted", "text-danger")  // ë¹¨ê°•
                } else {
                    likeIcon.classList.replace("fas", "far")
                    likeIcon.classList.replace("text-danger", "text-muted")
                }
            } catch (error) {
                console.error("ì¢‹ì•„ìš” ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨", error)
            }
        }

        // ì¢‹ì•„ìš” í´ë¦­
        likeBtn.addEventListener("click", async () => {
            try {
                const response = await axios.post(`/place/${placeId}/like`)
                const count = parseInt(response.data)
                if (count === -1) {
                    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.")
                    return
                }
                await loadLikeStatus()
            } catch (error) {
                if (error.response?.status === 401) {
                    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.")
                } else {
                    alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                }
            }
        })
        // // ì´ˆê¸° ë¡œë“œ
        // await loadLikeStatus();

        // ëŒ“ê¸€ ëª©ë¡ + í˜ì´ì§€ë„¤ì´ì…˜
        async function loadReplies(page = 1) {
            const response = await axios.get(`/replies/list/place/${placeId}`, { params: { page, size: 5 } })
            const data = response.data

            replyList.innerHTML = ""
            const paginationEl = document.querySelector("#replyPagination")
            paginationEl.innerHTML = ""

            if (!data || data.dtoList.length === 0) {
                replyList.innerHTML = `<li class="list-group-item text-center text-muted">ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>`
                return
            }

            // ëŒ“ê¸€ ë Œë”ë§
            data.dtoList.forEach(reply => {
                const li = document.createElement("li")
                li.className = "list-group-item px-3 py-2"
                const showButtons = loggedInUser === reply.username || isAdmin

                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${reply.username}</strong>
                            <p class="mb-1">${reply.content}</p>
                            <small>${reply.regDate ? reply.regDate.replace('T', ' ') : ''}</small>
                        </div>
                        <div>
                            ${showButtons ? `
                                <button class="btn btn-sm edit-btn" data-rno="${reply.rno}">ìˆ˜ì •</button>
                                <button class="btn btn-sm delete-btn" data-rno="${reply.rno}">ì‚­ì œ</button>
                            ` : ''}
                        </div>
                    </div>`
                replyList.appendChild(li)
            })

            // í˜ì´ì§€ ë²„íŠ¼ ìƒì„±
            const totalPages = Math.ceil(data.total / 5)
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li")
                li.className = `page-item ${i === page ? 'active' : ''}`
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`
                li.addEventListener("click", (e) => {
                    e.preventDefault()
                    loadReplies(i)
                })
                paginationEl.appendChild(li)
            }
        }

        // ëŒ“ê¸€ ë“±ë¡
        replyRegisterBtn.addEventListener("click", async () => {
            const content = replyContent.value.trim()
            const username = replyWriter.value.trim()

            if (!content) {
                alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.")
                return
            }

            const replyObj = { content, username, placeId, type: "PLACE" }

            await axios.post("/replies", replyObj)
            replyContent.value = ""
            await loadReplies()
        })

        // ëŒ“ê¸€ ìˆ˜ì • / ì‚­ì œ
        replyList.addEventListener("click", async (e) => {
            const target = e.target
            const rno = target.dataset.rno
            if (target.classList.contains("delete-btn")) {
                if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    await axios.delete(`/replies/${rno}`)
                    await loadReplies()
                }
            } else if (target.classList.contains("edit-btn")) {
                const newContent = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:")
                if (newContent && newContent.trim() !== "") {
                    await axios.put(`/replies/${rno}`, {
                        rno,
                        content: newContent,
                        username: replyWriter.value,
                        placeId,
                        type: "PLACE"
                    })
                    await loadReplies()
                }
            }
        })

        // // ì´ˆê¸° ë¡œë”©
        // await loadReplies()
        // ì´ˆê¸° ë¡œë”©
        await loadLikeStatus()
        await loadFavoriteStatus()
        await loadReplies()
    })
</script>
</body>
</html>

